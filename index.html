<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äºŒç‹—æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            background-color: #222;
            color: white;
            touch-action: manipulation;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* å¼€åœºç”»é¢æ ·å¼ */
        #splash-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e5799 0%,#2989d8 50%,#207cca 51%,#7db9e8 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
        }
        
        #splash-screen h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* ç™»å½•ç•Œé¢æ ·å¼ */
        #login-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #333, #111);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 90;
        }
        
        #login-form, #register-form {
            background-color: rgba(0,0,0,0.7);
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        
        .form-title {
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #333;
            color: white;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #2989d8;
            color: white;
            cursor: pointer;
            margin: 5px;
            width: 100%;
        }
        
        .btn:hover {
            background-color: #1e5799;
        }
        
        .switch-form {
            margin-top: 15px;
            color: #aaa;
            cursor: pointer;
        }
        
        .switch-form:hover {
            color: white;
        }
        
        /* ä¸»èœå•æ ·å¼ */
        #main-menu {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #222, #000);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 80;
        }
        
        #menu-title {
            font-size: 2.5rem;
            margin-bottom: 50px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .menu-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            background-color: #2989d8;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            margin: 10px;
            width: 200px;
            text-align: center;
        }
        
        .menu-btn:hover {
            background-color: #1e5799;
        }
        
        #player-coins {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.2rem;
            background-color: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 5px;
        }
        
        /* å•†åº—ç•Œé¢ */
        #shop-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #222, #000);
            display: none;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            z-index: 85;
        }
        
        #shop-title {
            font-size: 2rem;
            margin-bottom: 20px;
        }
        
        .shop-item {
            width: 80%;
            max-width: 400px;
            background-color: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .item-price {
            color: gold;
        }
        
        .buy-btn {
            padding: 8px 15px;
            background-color: #4CAF50;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }
        
        .buy-btn:hover {
            background-color: #45a049;
        }
        
        .buy-btn:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        
        #back-to-menu {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #ff5722;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }
        
        /* è®¾ç½®ç•Œé¢ */
        #settings-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #222, #000);
            display: none;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            z-index: 85;
        }
        
        #settings-title {
            font-size: 2rem;
            margin-bottom: 20px;
        }
        
        .setting-item {
            width: 80%;
            max-width: 400px;
            background-color: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .setting-name {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        /* æ¸¸æˆç•Œé¢ */
        #game-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: #111;
            display: none;
            flex-direction: column;
            z-index: 70;
        }
        
        #game-header {
            padding: 10px;
            background-color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #player-info {
            display: flex;
            align-items: center;
        }
        
        #player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #2989d8;
            margin-right: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        
        #game-area {
            display: none;
            width: 100%;
            height: 100%;
            position: relative;
            background-color: #000;
            overflow: hidden;
        }
        
        #player {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: #2989d8;
            border-radius: 50%;
            left: 50%;
            bottom: 100px;
            transform: translateX(-50%);
        }
        
        .enemy {
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: #ff5722;
            border-radius: 50%;
        }
        
        .bullet {
            position: absolute;
            width: 10px;
            height: 20px;
            background-color: #ffeb3b;
            border-radius: 5px;
        }
        
        .coin {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: gold;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #333;
        }
        
        #score-display {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.2rem;
            color: white;
        }
        
        #health-display {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
            color: white;
        }
        
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #game-over h2 {
            font-size: 2.5rem;
            color: #ff5722;
            margin-bottom: 20px;
        }
        
        #final-score {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }
        
        #restart-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            background-color: #2989d8;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10;
        }
        
        #move-controls {
            display: flex;
            gap: 20px;
        }
        
        #fire-control {
            margin-left: auto;
        }
        
        .control-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            user-select: none;
            -webkit-user-select: none;
        }
        
        #fire-btn {
            background-color: rgba(255, 0, 0, 0.5);
        }
        
        #fire-btn:active {
            background-color: rgba(255, 0, 0, 0.8);
        }
        
        .control-btn:active {
            background-color: rgba(255, 255, 255, 0.4);
        }
        
        /* æ¨ªå±æç¤º */
        #orientation-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 200;
        }
        
        #orientation-message p {
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- å¼€åœºç”»é¢ -->
        <div id="splash-screen">
            <h1>äºŒç‹—æ¸¸æˆ</h1>
            <p>åŠ è½½ä¸­...</p>
        </div>
        
        <!-- ç™»å½•ç•Œé¢ -->
        <div id="login-screen">
            <div id="login-form">
                <h2 class="form-title">ç™»å½•</h2>
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 15px;">è´¦æˆ·åªèƒ½åœ¨æœ¬è®¾å¤‡ç™»å½•</p>
                <button id="login-btn" class="btn">ç™»å½•</button>
                <p class="switch-form" id="show-register">æ³¨å†Œæ–°è´¦æˆ·</p>
            </div>
            
            <div id="register-form" style="display: none;">
                <h2 class="form-title">æ³¨å†Œ</h2>
                <div class="form-group">
                    <label for="reg-username">ç”¨æˆ·å</label>
                    <input type="text" id="reg-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label for="reg-password">å¯†ç </label>
                    <input type="password" id="reg-password" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <div class="form-group">
                    <label for="reg-password2">é‡å¤å¯†ç </label>
                    <input type="password" id="reg-password2" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                </div>
                <button id="register-btn" class="btn">æ³¨å†Œ</button>
                <p class="switch-form" id="show-login">è¿”å›ç™»å½•</p>
            </div>
        </div>
        
        <!-- ä¸»èœå• -->
        <div id="main-menu">
            <h1 id="menu-title">é£æœºå¤§æˆ˜</h1>
            <button id="start-game-btn" class="menu-btn">å¼€å§‹æ¸¸æˆ</button>
            <button id="shop-btn" class="menu-btn">å•†åº—</button>
            <button id="settings-btn" class="menu-btn">è®¾ç½®</button>
            <button id="quit-game-btn" class="menu-btn">é€€å‡ºç™»å½•</button>
            <div id="player-coins">é‡‘å¸: 0</div>
        </div>
        
        <!-- å•†åº—ç•Œé¢ -->
        <div id="shop-screen">
            <h1 id="shop-title">å•†åº—</h1>
            <div class="shop-item">
                <div class="item-info">
                    <div class="item-name">é¢å¤–ç”Ÿå‘½</div>
                    <div class="item-desc">å¢åŠ ä¸€æ¡ç”Ÿå‘½</div>
                    <div class="item-price">ä»·æ ¼: 100é‡‘å¸</div>
                </div>
                <button class="buy-btn" id="buy-health">è´­ä¹°</button>
            </div>
            <div class="shop-item">
                <div class="item-info">
                    <div class="item-name">åŒå€åˆ†æ•°</div>
                    <div class="item-desc">æ¸¸æˆå¾—åˆ†ç¿»å€</div>
                    <div class="item-price">ä»·æ ¼: 200é‡‘å¸</div>
                </div>
                <button class="buy-btn" id="buy-double">è´­ä¹°</button>
            </div>
            <div class="shop-item">
                <div class="item-info">
                    <div class="item-name">æŠ¤ç›¾</div>
                    <div class="item-desc">æŠµæŒ¡ä¸€æ¬¡ä¼¤å®³</div>
                    <div class="item-price">ä»·æ ¼: 150é‡‘å¸</div>
                </div>
                <button class="buy-btn" id="buy-shield">è´­ä¹°</button>
            </div>
            <button id="back-to-menu">è¿”å›ä¸»é¡µ</button>
        </div>
        
        <!-- è®¾ç½®ç•Œé¢ -->
        <div id="settings-screen">
            <h1 id="settings-title">è®¾ç½®</h1>
            <div class="setting-item">
                <div class="setting-name">éŸ³é‡æ§åˆ¶</div>
                <input type="range" id="volume-control" min="0" max="100" value="50">
            </div>
            <div class="setting-item">
                <div class="setting-name">æ§åˆ¶æ–¹å¼</div>
                <select id="control-type">
                    <option value="buttons">å±å¹•æŒ‰é’®</option>
                    <option value="keyboard">é”®ç›˜æ§åˆ¶</option>
                </select>
            </div>
            <button id="back-to-menu-from-settings">è¿”å›ä¸»é¡µ</button>
        </div>
        
        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="game-screen">
            <div id="game-header">
                <div id="player-info">
                    <div id="player-avatar">P</div>
                    <span id="player-name">ç©å®¶</span>
                </div>
                <button id="back-to-menu-btn" class="btn">è¿”å›èœå•</button>
            </div>
            
            <div id="game-area">
                <div id="player"></div>
                <div id="score-display">åˆ†æ•°: 0</div>
                <div id="health-display">ç”Ÿå‘½: 3</div>
                
                <!-- æ§åˆ¶æŒ‰é’® -->
                <div id="controls">
                    <div id="move-controls">
                        <div id="left-btn" class="control-btn">â†</div>
                        <div id="right-btn" class="control-btn">â†’</div>
                    </div>
                    <div id="fire-control">
                        <div id="fire-btn" class="control-btn">ğŸ”¥</div>
                    </div>
                </div>
                
                <div id="game-over">
                    <h2>æ¸¸æˆç»“æŸ</h2>
                    <div id="final-score">æœ€ç»ˆåˆ†æ•°: 0</div>
                    <button id="restart-btn">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </div>
        
        <!-- æ¨ªå±æç¤º -->
        <div id="orientation-message">
            <p>è¯·å°†è®¾å¤‡æ¨ªå±ä»¥è·å¾—æœ€ä½³æ¸¸æˆä½“éªŒ</p>
        </div>
    </div>

    <script>
        // æœ¬åœ°å­˜å‚¨é”®å
        const STORAGE_KEYS = {
            ACCOUNTS: 'erGouGameAccounts',
            PLAYER_DATA: 'erGouGamePlayerData'
        };
        
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            player: {
                name: 'ç©å®¶',
                score: 0,
                health: 3,
                coins: 0,
                position: 0,
                isMovingLeft: false,
                isMovingRight: false,
                items: {
                    doubleScore: false,
                    shield: false
                }
            },
            gameActive: false,
            enemies: [],
            bullets: [],
            coins: [],
            lastEnemySpawn: 0,
            lastCoinSpawn: 0,
            keysPressed: {},
            lastFireTime: 0,
            fireCooldown: 300,
            currentScreen: 'login'
        };
        
        // DOMå…ƒç´ 
        const elements = {
            splashScreen: document.getElementById('splash-screen'),
            loginScreen: document.getElementById('login-screen'),
            mainMenu: document.getElementById('main-menu'),
            shopScreen: document.getElementById('shop-screen'),
            settingsScreen: document.getElementById('settings-screen'),
            gameScreen: document.getElementById('game-screen'),
            gameArea: document.getElementById('game-area'),
            player: document.getElementById('player'),
            playerName: document.getElementById('player-name'),
            playerAvatar: document.getElementById('player-avatar'),
            playerCoins: document.getElementById('player-coins'),
            startGameBtn: document.getElementById('start-game-btn'),
            shopBtn: document.getElementById('shop-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            quitGameBtn: document.getElementById('quit-game-btn'),
            backToMenuBtn: document.getElementById('back-to-menu-btn'),
            backToMenuFromShop: document.getElementById('back-to-menu'),
            backToMenuFromSettings: document.getElementById('back-to-menu-from-settings'),
            gameStartBtn: document.getElementById('game-start-btn'),
            scoreDisplay: document.getElementById('score-display'),
            healthDisplay: document.getElementById('health-display'),
            gameOver: document.getElementById('game-over'),
            finalScore: document.getElementById('final-score'),
            restartBtn: document.getElementById('restart-btn'),
            orientationMessage: document.getElementById('orientation-message'),
            leftBtn: document.getElementById('left-btn'),
            rightBtn: document.getElementById('right-btn'),
            fireBtn: document.getElementById('fire-btn'),
            buyHealthBtn: document.getElementById('buy-health'),
            buyDoubleBtn: document.getElementById('buy-double'),
            buyShieldBtn: document.getElementById('buy-shield'),
            usernameInput: document.getElementById('username'),
            passwordInput: document.getElementById('password'),
            regUsernameInput: document.getElementById('reg-username'),
            regPasswordInput: document.getElementById('reg-password'),
            regPassword2Input: document.getElementById('reg-password2')
        };
        
        // ä»æœ¬åœ°å­˜å‚¨è·å–è´¦æˆ·æ•°æ®
        function getAccountsFromStorage() {
            const accountsJson = localStorage.getItem(STORAGE_KEYS.ACCOUNTS);
            return accountsJson ? JSON.parse(accountsJson) : {};
        }
        
        // ä¿å­˜è´¦æˆ·æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveAccountsToStorage(accounts) {
            localStorage.setItem(STORAGE_KEYS.ACCOUNTS, JSON.stringify(accounts));
        }
        
        // ä»æœ¬åœ°å­˜å‚¨è·å–ç©å®¶æ•°æ®
        function getPlayerDataFromStorage(username) {
            const allDataJson = localStorage.getItem(STORAGE_KEYS.PLAYER_DATA);
            const allData = allDataJson ? JSON.parse(allDataJson) : {};
            return allData[username] || {
                coins: 0,
                items: {
                    doubleScore: false,
                    shield: false
                }
            };
        }
        
        // ä¿å­˜ç©å®¶æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function savePlayerDataToStorage(username, data) {
            const allDataJson = localStorage.getItem(STORAGE_KEYS.PLAYER_DATA);
            const allData = allDataJson ? JSON.parse(allDataJson) : {};
            allData[username] = data;
            localStorage.setItem(STORAGE_KEYS.PLAYER_DATA, JSON.stringify(allData));
        }
        
        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦å­˜åœ¨
        function accountExists(username) {
            const accounts = getAccountsFromStorage();
            return accounts.hasOwnProperty(username);
        }
        
        // éªŒè¯è´¦æˆ·å¯†ç 
        function validateAccount(username, password) {
            const accounts = getAccountsFromStorage();
            return accounts[username] && accounts[username] === password;
        }
        
        // æ³¨å†Œæ–°è´¦æˆ·
        function registerAccount(username, password) {
            const accounts = getAccountsFromStorage();
            accounts[username] = password;
            saveAccountsToStorage(accounts);
            
            // åˆå§‹åŒ–ç©å®¶æ•°æ®
            const playerData = {
                coins: 0,
                items: {
                    doubleScore: false,
                    shield: false
                }
            };
            savePlayerDataToStorage(username, playerData);
        }
        
        // æ›´æ–°UIæ˜¾ç¤ºç©å®¶æ•°æ®
        function updatePlayerDataUI() {
            elements.playerCoins.textContent = `é‡‘å¸: ${gameState.player.coins}`;
        }
        
        // æ£€æŸ¥æ¨ªå±
        function checkOrientation() {
            if (window.innerHeight > window.innerWidth) {
                elements.orientationMessage.style.display = 'flex';
            } else {
                elements.orientationMessage.style.display = 'none';
            }
        }
        
        // åˆ‡æ¢å±å¹•
        function showScreen(screenName) {
            // éšè—æ‰€æœ‰å±å¹•
            elements.loginScreen.style.display = 'none';
            elements.mainMenu.style.display = 'none';
            elements.shopScreen.style.display = 'none';
            elements.settingsScreen.style.display = 'none';
            elements.gameScreen.style.display = 'none';
            
            // æ˜¾ç¤ºç›®æ ‡å±å¹•
            switch(screenName) {
                case 'login':
                    elements.loginScreen.style.display = 'flex';
                    break;
                case 'menu':
                    elements.mainMenu.style.display = 'flex';
                    updatePlayerDataUI();
                    break;
                case 'shop':
                    elements.shopScreen.style.display = 'flex';
                    break;
                case 'settings':
                    elements.settingsScreen.style.display = 'flex';
                    break;
                case 'game':
                    elements.gameScreen.style.display = 'flex';
                    break;
            }
            
            gameState.currentScreen = screenName;
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.player.score = 0;
            gameState.player.health = 3;
            gameState.player.position = 0;
            gameState.gameActive = true;
            gameState.enemies = [];
            gameState.bullets = [];
            gameState.coins = [];
            gameState.lastEnemySpawn = 0;
            gameState.lastCoinSpawn = 0;
            gameState.lastFireTime = 0;
            
            // æ›´æ–°UI
            elements.scoreDisplay.textContent = `åˆ†æ•°: ${gameState.player.score}`;
            elements.healthDisplay.textContent = `ç”Ÿå‘½: ${gameState.player.health}`;
            elements.gameOver.style.display = 'none';
            
            // æ¸…é™¤æ‰€æœ‰æ•Œäººã€å­å¼¹å’Œé‡‘å¸
            document.querySelectorAll('.enemy, .bullet, .coin').forEach(el => el.remove());
            
            // é‡ç½®ç©å®¶ä½ç½®
            elements.player.style.left = '50%';
            elements.player.style.bottom = '100px';
            gameState.player.position = window.innerWidth / 2;
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            gameLoop();
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!gameState.gameActive) return;
            
            const now = Date.now();
            
            // ç”Ÿæˆæ•Œäºº
            if (now - gameState.lastEnemySpawn > 1500) {
                spawnEnemy();
                gameState.lastEnemySpawn = now;
            }
            
            // ç”Ÿæˆé‡‘å¸
            if (now - gameState.lastCoinSpawn > 3000) {
                spawnCoin();
                gameState.lastCoinSpawn = now;
            }
            
            // ç§»åŠ¨ç©å®¶
            movePlayer();
            
            // ç§»åŠ¨å­å¼¹
            moveBullets();
            
            // ç§»åŠ¨æ•Œäºº
            moveEnemies();
            
            // ç§»åŠ¨é‡‘å¸
            moveCoins();
            
            // æ£€æµ‹ç¢°æ’
            checkCollisions();
            
            // ç»§ç»­å¾ªç¯
            requestAnimationFrame(gameLoop);
        }
        
        // ç”Ÿæˆæ•Œäºº
        function spawnEnemy() {
            const enemy = document.createElement('div');
            enemy.className = 'enemy';
            enemy.style.left = `${Math.random() * (window.innerWidth - 40)}px`;
            enemy.style.top = '-40px';
            elements.gameArea.appendChild(enemy);
            
            gameState.enemies.push({
                element: enemy,
                x: parseInt(enemy.style.left),
                y: -40,
                speed: 2 + Math.random() * 3
            });
        }
        
        // ç”Ÿæˆé‡‘å¸
        function spawnCoin() {
            const coin = document.createElement('div');
            coin.className = 'coin';
            coin.textContent = '$';
            coin.style.left = `${Math.random() * (window.innerWidth - 30)}px`;
            coin.style.top = '-30px';
            elements.gameArea.appendChild(coin);
            
            gameState.coins.push({
                element: coin,
                x: parseInt(coin.style.left),
                y: -30,
                speed: 1 + Math.random() * 2,
                value: gameState.player.items.doubleScore ? 20 : 10
            });
        }
        
        // ç§»åŠ¨ç©å®¶
        function movePlayer() {
            const playerSpeed = 8;
            
            if (gameState.isMovingLeft && gameState.player.position > 25) {
                gameState.player.position -= playerSpeed;
            }
            
            if (gameState.isMovingRight && gameState.player.position < window.innerWidth - 25) {
                gameState.player.position += playerSpeed;
            }
            
            elements.player.style.left = `${gameState.player.position}px`;
        }
        
        // ç§»åŠ¨å­å¼¹
        function moveBullets() {
            for (let i = gameState.bullets.length - 1; i >= 0; i--) {
                const bullet = gameState.bullets[i];
                bullet.y -= 8;
                bullet.element.style.top = `${bullet.y}px`;
                
                // ç§»é™¤è¶…å‡ºå±å¹•çš„å­å¼¹
                if (bullet.y < -20) {
                    bullet.element.remove();
                    gameState.bullets.splice(i, 1);
                }
            }
        }
        
        // ç§»åŠ¨æ•Œäºº
        function moveEnemies() {
            for (let i = gameState.enemies.length - 1; i >= 0; i--) {
                const enemy = gameState.enemies[i];
                enemy.y += enemy.speed;
                enemy.element.style.top = `${enemy.y}px`;
                
                // ç§»é™¤è¶…å‡ºå±å¹•çš„æ•Œäºº
                if (enemy.y > window.innerHeight) {
                    enemy.element.remove();
                    gameState.enemies.splice(i, 1);
                }
            }
        }
        
        // ç§»åŠ¨é‡‘å¸
        function moveCoins() {
            for (let i = gameState.coins.length - 1; i >= 0; i--) {
                const coin = gameState.coins[i];
                coin.y += coin.speed;
                coin.element.style.top = `${coin.y}px`;
                
                // ç§»é™¤è¶…å‡ºå±å¹•çš„é‡‘å¸
                if (coin.y > window.innerHeight) {
                    coin.element.remove();
                    gameState.coins.splice(i, 1);
                }
            }
        }
        
        // æ£€æµ‹ç¢°æ’
        function checkCollisions() {
            // å­å¼¹ä¸æ•Œäººç¢°æ’
            for (let i = gameState.bullets.length - 1; i >= 0; i--) {
                const bullet = gameState.bullets[i];
                const bulletRect = bullet.element.getBoundingClientRect();
                
                for (let j = gameState.enemies.length - 1; j >= 0; j--) {
                    const enemy = gameState.enemies[j];
                    const enemyRect = enemy.element.getBoundingClientRect();
                    
                    if (isColliding(bulletRect, enemyRect)) {
                        // å­å¼¹å‡»ä¸­æ•Œäºº
                        bullet.element.remove();
                        gameState.bullets.splice(i, 1);
                        
                        enemy.element.remove();
                        gameState.enemies.splice(j, 1);
                        
                        // å¢åŠ åˆ†æ•°
                        const scoreIncrease = gameState.player.items.doubleScore ? 10 : 5;
                        gameState.player.score += scoreIncrease;
                        elements.scoreDisplay.textContent = `åˆ†æ•°: ${gameState.player.score}`;
                        
                        break;
                    }
                }
            }
            
            // ç©å®¶ä¸æ•Œäººç¢°æ’
            const playerRect = elements.player.getBoundingClientRect();
            
            for (let i = gameState.enemies.length - 1; i >= 0; i--) {
                const enemy = gameState.enemies[i];
                const enemyRect = enemy.element.getBoundingClientRect();
                
                if (isColliding(playerRect, enemyRect)) {
                    // ç©å®¶è¢«æ•Œäººå‡»ä¸­
                    enemy.element.remove();
                    gameState.enemies.splice(i, 1);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æŠ¤ç›¾
                    if (gameState.player.items.shield) {
                        gameState.player.items.shield = false;
                        alert('æŠ¤ç›¾æŠµæŒ¡äº†ä¸€æ¬¡ä¼¤å®³ï¼');
                    } else {
                        gameState.player.health--;
                        elements.healthDisplay.textContent = `ç”Ÿå‘½: ${gameState.player.health}`;
                        
                        if (gameState.player.health <= 0) {
                            gameOver();
                        }
                    }
                }
            }
            
            // ç©å®¶ä¸é‡‘å¸ç¢°æ’
            for (let i = gameState.coins.length - 1; i >= 0; i--) {
                const coin = gameState.coins[i];
                const coinRect = coin.element.getBoundingClientRect();
                
                if (isColliding(playerRect, coinRect)) {
                    // ç©å®¶æ”¶é›†é‡‘å¸
                    coin.element.remove();
                    gameState.coins.splice(i, 1);
                    
                    // å¢åŠ åˆ†æ•°
                    gameState.player.score += coin.value;
                    elements.scoreDisplay.textContent = `åˆ†æ•°: ${gameState.player.score}`;
                }
            }
        }
        
        // ç¢°æ’æ£€æµ‹
        function isColliding(rect1, rect2) {
            return !(
                rect1.right < rect2.left || 
                rect1.left > rect2.right || 
                rect1.bottom < rect2.top || 
                rect1.top > rect2.bottom
            );
        }
        
        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameState.gameActive = false;
            
            // å°†åˆ†æ•°è½¬åŒ–ä¸ºé‡‘å¸ (10åˆ† = 1é‡‘å¸)
            const earnedCoins = Math.floor(gameState.player.score / 10);
            gameState.player.coins += earnedCoins;
            
            // ä¿å­˜ç©å®¶æ•°æ®
            savePlayerDataToStorage(gameState.player.name, {
                coins: gameState.player.coins,
                items: gameState.player.items
            });
            
            elements.finalScore.textContent = `æœ€ç»ˆåˆ†æ•°: ${gameState.player.score} (è·å¾— ${earnedCoins} é‡‘å¸)`;
            elements.gameOver.style.display = 'flex';
        }
        
        // å‘å°„å­å¼¹
        function fireBullet() {
            if (!gameState.gameActive) return;
            
            const now = Date.now();
            if (now - gameState.lastFireTime < gameState.fireCooldown) return;
            
            gameState.lastFireTime = now;
            
            const bullet = document.createElement('div');
            bullet.className = 'bullet';
            bullet.style.left = `${gameState.player.position - 5}px`;
            bullet.style.top = `${window.innerHeight - 150}px`;
            elements.gameArea.appendChild(bullet);
            
            gameState.bullets.push({
                element: bullet,
                x: gameState.player.position - 5,
                y: window.innerHeight - 150
            });
        }
        
        // è´­ä¹°ç‰©å“
        function buyItem(itemType, price) {
            if (gameState.player.coins < price) {
                alert('é‡‘å¸ä¸è¶³ï¼');
                return false;
            }
            
            gameState.player.coins -= price;
            
            switch(itemType) {
                case 'health':
                    gameState.player.health++;
                    break;
                case 'double':
                    gameState.player.items.doubleScore = true;
                    break;
                case 'shield':
                    gameState.player.items.shield = true;
                    break;
            }
            
            // ä¿å­˜ç©å®¶æ•°æ®
            savePlayerDataToStorage(gameState.player.name, {
                coins: gameState.player.coins,
                items: gameState.player.items
            });
            
            updatePlayerDataUI();
            return true;
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('load', function() {
            checkOrientation();
            window.addEventListener('resize', checkOrientation);
            
            // å¼€åœºåŠ¨ç”»20ç§’
            setTimeout(function() {
                elements.splashScreen.style.display = 'none';
                showScreen('login');
            }, 20000);
            
            // ç™»å½•/æ³¨å†Œåˆ‡æ¢
            document.getElementById('show-register').addEventListener('click', function() {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            });
            
            document.getElementById('show-login').addEventListener('click', function() {
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            });
            
            // ç™»å½•æŒ‰é’®
            document.getElementById('login-btn').addEventListener('click', function() {
                const username = elements.usernameInput.value.trim();
                const password = elements.passwordInput.value.trim();
                
                if (!username || !password) {
                    alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                    return;
                }
                
                // æ£€æŸ¥è´¦æˆ·æ˜¯å¦å­˜åœ¨
                if (!accountExists(username)) {
                    if (confirm('è´¦æˆ·ä¸å­˜åœ¨ï¼Œæ˜¯å¦è¦æ³¨å†Œæ–°è´¦æˆ·ï¼Ÿ')) {
                        document.getElementById('login-form').style.display = 'none';
                        document.getElementById('register-form').style.display = 'block';
                        elements.regUsernameInput.value = username;
                        elements.regPasswordInput.value = password;
                        elements.regPassword2Input.value = password;
                    }
                    return;
                }
                
                // éªŒè¯å¯†ç 
                if (!validateAccount(username, password)) {
                    alert('å¯†ç é”™è¯¯');
                    return;
                }
                
                // ç™»å½•æˆåŠŸï¼ŒåŠ è½½ç©å®¶æ•°æ®
                gameState.player.name = username;
                const playerData = getPlayerDataFromStorage(username);
                gameState.player.coins = playerData.coins;
                gameState.player.items = playerData.items;
                
                elements.playerName.textContent = username;
                elements.playerAvatar.textContent = username.charAt(0).toUpperCase();
                
                showScreen('menu');
            });
            
            // æ³¨å†ŒæŒ‰é’®
            document.getElementById('register-btn').addEventListener('click', function() {
                const username = elements.regUsernameInput.value.trim();
                const password = elements.regPasswordInput.value.trim();
                const password2 = elements.regPassword2Input.value.trim();
                
                if (!username || !password || !password2) {
                    alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                    return;
                }
                
                if (password !== password2) {
                    alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                    return;
                }
                
                // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
                if (accountExists(username)) {
                    alert('ç”¨æˆ·åå·²å­˜åœ¨');
                    return;
                }
                
                // æ³¨å†Œæ–°è´¦æˆ·
                registerAccount(username, password);
                alert('æ³¨å†ŒæˆåŠŸï¼');
                
                // è‡ªåŠ¨å¡«å……ç™»å½•è¡¨å•
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
                elements.usernameInput.value = username;
                elements.passwordInput.value = password;
            });
            
            // ä¸»èœå•æŒ‰é’®
            elements.startGameBtn.addEventListener('click', function() {
                showScreen('game');
                elements.gameArea.style.display = 'block';
                initGame();
            });
            
            elements.shopBtn.addEventListener('click', function() {
                showScreen('shop');
            });
            
            elements.settingsBtn.addEventListener('click', function() {
                showScreen('settings');
            });
            
            elements.quitGameBtn.addEventListener('click', function() {
                showScreen('login');
            });
            
            // è¿”å›æŒ‰é’®
            elements.backToMenuBtn.addEventListener('click', function() {
                showScreen('menu');
            });
            
            elements.backToMenuFromShop.addEventListener('click', function() {
                showScreen('menu');
            });
            
            elements.backToMenuFromSettings.addEventListener('click', function() {
                showScreen('menu');
            });
            
            // å•†åº—è´­ä¹°æŒ‰é’®
            elements.buyHealthBtn.addEventListener('click', function() {
                if (buyItem('health', 100)) {
                    alert('è´­ä¹°æˆåŠŸï¼ç”Ÿå‘½å€¼+1');
                }
            });
            
            elements.buyDoubleBtn.addEventListener('click', function() {
                if (buyItem('double', 200)) {
                    alert('è´­ä¹°æˆåŠŸï¼ä¸‹æ¬¡æ¸¸æˆå¾—åˆ†ç¿»å€');
                }
            });
            
            elements.buyShieldBtn.addEventListener('click', function() {
                if (buyItem('shield', 150)) {
                    alert('è´­ä¹°æˆåŠŸï¼è·å¾—ä¸€ä¸ªæŠ¤ç›¾');
                }
            });
            
            // é‡æ–°å¼€å§‹æŒ‰é’®
            elements.restartBtn.addEventListener('click', function() {
                elements.gameOver.style.display = 'none';
                initGame();
            });
            
            // é”®ç›˜æ§åˆ¶
            window.addEventListener('keydown', function(e) {
                gameState.keysPressed[e.key] = true;
                
                if (e.key === 'ArrowLeft') {
                    gameState.isMovingLeft = true;
                } else if (e.key === 'ArrowRight') {
                    gameState.isMovingRight = true;
                } else if (e.key === ' ' || e.key === 'Spacebar') {
                    fireBullet();
                }
            });
            
            window.addEventListener('keyup', function(e) {
                gameState.keysPressed[e.key] = false;
                
                if (e.key === 'ArrowLeft') {
                    gameState.isMovingLeft = false;
                } else if (e.key === 'ArrowRight') {
                    gameState.isMovingRight = false;
                }
            });
            
            // è§¦æ‘¸æ§åˆ¶ - ç§»åŠ¨æŒ‰é’®
            elements.leftBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                gameState.isMovingLeft = true;
                gameState.isMovingRight = false;
            });
            
            elements.leftBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                gameState.isMovingLeft = false;
            });
            
            elements.rightBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                gameState.isMovingRight = true;
                gameState.isMovingLeft = false;
            });
            
            elements.rightBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                gameState.isMovingRight = false;
            });
            
            // è§¦æ‘¸æ§åˆ¶ - å‘å°„æŒ‰é’®
            elements.fireBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                fireBullet();
            });
            
            // ç‚¹å‡»å‘å°„æŒ‰é’®
            elements.fireBtn.addEventListener('click', function() {
                fireBullet();
            });
            
            // ç‚¹å‡»æ¸¸æˆåŒºåŸŸå‘å°„å­å¼¹
            elements.gameArea.addEventListener('click', function(e) {
                // åªæœ‰å½“ç‚¹å‡»çš„ä¸æ˜¯æ§åˆ¶æŒ‰é’®æ—¶æ‰å‘å°„å­å¼¹
                if (!e.target.closest('.control-btn')) {
                    fireBullet();
                }
            });
        });
    </script>
</body>
</html>
